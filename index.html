<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Apple SD Gothic Neo', sans-serif; padding: 20px; background-color: #f9f9f9; }
    .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 900px; margin: 0 auto; }
    h2 { margin-top: 0; font-size: 24px; color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; } 
    th, td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    th { background: #f8f8f8; color: #555; font-weight: bold; }

    .col-chk { width: 40px; } .col-no { width: 60px; } .col-date { width: 100px; }
    .col-title { width: auto; text-align: left; padding-left: 15px; } 
    .title-text { cursor: pointer; color: #333; text-decoration: none; display: block; width: 100%; overflow: hidden; text-overflow: ellipsis; }
    .title-text:hover { text-decoration: underline; color: #4285f4; }
    .badge-wait { color: #ff5252; font-weight: bold; font-size: 11px; margin-right: 5px; border:1px solid #ff5252; padding: 1px 3px; border-radius: 3px; background:#fff; }
    
    #bulkActionArea { display: none; background: #e8f0fe; padding: 10px; margin-bottom: 10px; border-radius: 5px; text-align: right; align-items: center; justify-content: flex-end; gap: 5px; }
    
    .btn-custom { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 13px; transition: 0.2s; }
    .btn-admin { background: #eee; color: #555; }
    .btn-write { background: #4285f4; color: white; display: none; }
    .btn-more { width: 100%; background: #fff; border: 1px solid #ddd; padding: 10px; margin-top: 10px; color: #666; }
    .btn-danger { background: #ff5252; color: white; }
    .btn-success { background: #28a745; color: white; }
    
    .file-accordion-btn { display: flex; align-items: center; width: 100%; text-align: left; background: #f8f9fa; border: 1px solid #ddd; padding: 12px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; color: #333; font-weight: bold; transition: 0.2s; }
    .file-accordion-btn:hover { background: #e8eaed; border-color: #bbb; }
    .file-icon { margin-right: 8px; font-size: 16px; }
    
    .file-actions-panel { display: none; background: #fafafa; border: 1px solid #eee; border-top: none; padding: 15px; margin-bottom: 10px; margin-top: -6px; border-radius: 0 0 6px 6px; text-align: center; }
    .action-btn { display: inline-block; padding: 8px 16px; margin: 0 5px; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: bold; transition: 0.2s; cursor: pointer; }
    .btn-view { background-color: #4285f4; color: white; border: 1px solid #4285f4; }
    .btn-view:hover { background-color: #3367d6; color: white; text-decoration: none; }
    .btn-down { background-color: #fff; color: #555; border: 1px solid #ccc; }
    .btn-down:hover { background-color: #f1f1f1; color: #333; text-decoration: none; }

    .edit-file-item { display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid #ddd; padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; font-size: 13px; }
    .btn-file-del { background: #ff5252; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
    .btn-file-del:hover { background: #d32f2f; }

    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin-bottom: 20px; border-radius: 8px; background: #000; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-box { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.2); animation: popIn 0.2s; }
    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-header { padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #fff; box-sizing: border-box; }
    .modal-header h3 { flex-grow: 1; text-align: left; }
    .modal-header .close { font-size: 24px; cursor: pointer; padding: 0 5px; color:#999; border:none; background:none;}
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 15px; border-top: 1px solid #ddd; text-align: right; background: #f8f8f8; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-mini { max-width: 350px; height: auto; }
    
    .note-modal-backdrop { z-index: 2050 !important; }
    .note-modal { z-index: 2060 !important; }
    #systemModal { z-index: 3000; }
    
    .spinner-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 4000; justify-content: center; align-items: center; flex-direction: column; }
    .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="container">
  <h2><span>ğŸ“¢ ê³µì§€ì‚¬í•­ </span><div><button id="adminToggleBtn" class="btn-custom btn-admin" onclick="openLoginModal()">ğŸ”’ ê´€ë¦¬ì</button><button id="writeBtn" class="btn-custom btn-write" onclick="openWriteModal()">âœï¸ ê¸€ì“°ê¸°</button></div></h2>
  <div id="bulkActionArea">
    <span style="font-weight:bold; margin-right:10px; color:#333;">ì„ íƒ í•­ëª© :</span>
    <button class="btn-custom btn-success" onclick="doBulk('ê²Œì‹œ')">ì„ íƒ ê²Œì‹œ</button>
    <button class="btn-custom btn-admin" onclick="doBulk('ëŒ€ê¸°')">ì„ íƒ ëŒ€ê¸°</button>
    <button class="btn-custom btn-danger" onclick="doBulk('delete')">ì„ íƒ ì‚­ì œ</button>
  </div>
  <table>
    <thead><tr><th class="col-chk"><input type="checkbox" id="checkAll" onclick="toggleAllChecks()"></th><th class="col-no">No</th><th class="col-title">ì œëª©</th><th class="col-date">ë‚ ì§œ</th></tr></thead>
    <tbody id="listBody"></tbody>
  </table>
  <button id="moreBtn" class="btn-custom btn-more" onclick="loadList()">ë”ë³´ê¸° â–¾</button>
</div>

<div id="viewModal" class="modal-overlay" onclick="closeModal(event, 'viewModal', true)">
  <div class="modal-box">
    <div class="modal-header"><h3 id="vTitle" style="margin:0; font-size:18px;"></h3><button onclick="closeModalDirect('viewModal')" class="close">Ã—</button></div>
    <div id="vBody" class="modal-body" style="line-height:1.6;"></div>
    <div id="vContentEnd" style="padding: 20px; border-top: 1px dashed #ddd;"><div id="vMedia" style="margin-bottom: 15px;"></div><div id="vFiles"></div></div>
    <div id="vAdminArea" class="modal-footer" style="display:none;"></div>
  </div>
</div>

<div id="writeModal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header"><h3 id="wHeader" style="margin:0; font-size:18px;">ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±</h3><button onclick="handleWriteClose()" class="close">Ã—</button></div>
    <div class="modal-body">
      <input type="hidden" id="wRowNumber"><input type="hidden" id="wExistingFolderId"><input type="hidden" id="wIsSaved" value="false">
      <div style="margin-bottom:15px;"><input type="text" id="wTitle" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"></div>
      <div style="margin-bottom:15px;"><textarea id="summernote"></textarea><div style="font-size:12px; color:#ff5252; margin-top:5px;">â€» ì‚¬ì§„, ì˜ìƒ, ë¬¸ì„œëŠ” 'íŒŒì¼ ì¶”ê°€' ê¸°ëŠ¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”.</div></div>
      <div style="border:1px dashed #ddd; padding:10px; background:#fafafa; border-radius:4px;">
        <label style="font-weight:bold; display:block; margin-bottom:5px;">ğŸ“ ì²¨ë¶€íŒŒì¼ ê´€ë¦¬</label>
        <div id="existingFiles" style="margin-bottom:10px;"></div>
        <div id="fileList"><div style="margin-bottom:5px;"><input type="file" name="wFiles"></div></div>
        <button type="button" class="file-add-btn" onclick="addFileInput()">+ íŒŒì¼ ì¶”ê°€</button>
      </div>
    </div>
    <div class="modal-footer">
      <button id="btnCancel" class="btn-custom btn-admin" onclick="handleWriteClose()">ì·¨ì†Œ</button>
      <button class="btn-custom btn-admin" style="background:#ff9800; color:white;" onclick="submitPost('ëŒ€ê¸°')">ì„ì‹œì €ì¥ (ëŒ€ê¸°)</button>
      <button class="btn-custom btn-write" style="display:inline-block;" onclick="submitPost('ê²Œì‹œ')">ì‘ì„±ì™„ë£Œ (ê²Œì‹œ)</button>
    </div>
  </div>
</div>

<div id="loginModal" class="modal-overlay" onclick="closeModal(event, 'loginModal', true)"><div class="modal-box modal-mini"><div class="modal-header"><h3 style="margin:0; font-size:16px;">ê´€ë¦¬ì ì¸ì¦</h3><button onclick="closeModalDirect('loginModal')" class="close">Ã—</button></div><div class="modal-body" style="text-align:center;"><input type="password" id="adminPwInput" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; text-align:center;" onkeyup="if(event.keyCode==13) doLogin()"></div><div class="modal-footer" style="justify-content:center;"><button class="btn-custom btn-write" style="display:inline-block; width:100%;" onclick="doLogin()">í™•ì¸</button></div></div></div>
<div id="systemModal" class="modal-overlay"><div class="modal-box modal-mini"><div class="modal-header" style="border-bottom:none;"><h3 id="sysTitle" style="margin:0; font-size:16px;">ì•Œë¦¼</h3><button onclick="closeSystemModal()" class="close">Ã—</button></div><div id="sysMsg" class="modal-body" style="text-align:center; padding: 20px;"></div><div class="modal-footer" style="border-top:none; justify-content:center;" id="sysBtnArea"></div></div></div>
<div id="loadingOverlay" class="spinner-overlay"><div class="loader"></div><div id="loadingMsg" style="font-weight:bold; color:#555;">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div></div>
  
<script>
  // [1] ì•±ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ URL (ê¸°ì¡´ì— ì“°ì‹œë˜ /execë¡œ ëë‚˜ëŠ” ì£¼ì†Œ)
  var SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-ApS2hAOh1Gy3qLsH4njnR-PfLmaD4V-3qewhbgpIxzmqi81L5plWvqWCgAtHCKqRBQ/exec"; 
  
  // [2] ì•„ê¹Œ ë§Œë“œì‹  list.json íŒŒì¼ì˜ ID (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§í¬ ê³µìœ ì—ì„œ ê°€ì ¸ì˜¨ ê²ƒ)
  var JSON_FILE_ID = "1-BYJ55hyH2K2yx-ACU2wSz0NTjoFrM5a"; 

  // [ì „ì—­ ë³€ìˆ˜]
  var currentPage = 1; 
  var currentAdminKey = ""; 
  var isAdminMode = false; 
  var currentDetail = {};
  var cachedData = []; // [New] ë°ì´í„°ë¥¼ ë¸Œë¼ìš°ì € ë©”ëª¨ë¦¬ì— ì„ì‹œ ë³´ê´€í•  ë³€ìˆ˜

  $(document).ready(function() {
    loadList(); // ì‹œì‘í•˜ìë§ˆì ëª©ë¡ ë¡œë”©

    // ì¸ë¨¸ë…¸íŠ¸ ì—ë””í„° ì„¤ì •
    $('#summernote').summernote({
      placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...', tabsize: 2, height: 250, lang: 'ko-KR', dialogsInBody: true,
      toolbar: [['style',['style']],['font',['bold','underline','color']],['para',['ul','ol','paragraph']],['table',['table']],['insert',['link','hr']],['view',['fullscreen','codeview','help']]]
    });
    // ì‘ì„± ì¤‘ ë‚´ìš© ë³€ê²½ ê°ì§€
    $('#wTitle, #summernote').on('input change summernote.change', function() { $('#wIsSaved').val('false'); $('#btnCancel').text('ì·¨ì†Œ'); });
  });

  // [API í˜¸ì¶œ í•¨ìˆ˜] ê´€ë¦¬ì ì‘ì—…ì´ë‚˜ ë¹„ìƒì‹œì— ì‚¬ìš© (fetch API í™œìš©)
  function callApi(action, payload, onSuccess) {
    var data = payload || {};
    data.action = action;
    
    fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(json => { onSuccess(json); })
    .catch(err => {
       hideLoading();
       showModal("í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>" + err, 'alert');
       console.error(err);
    });
  }

  // [í•µì‹¬ ë³€ê²½] ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ìºì‹œ ìš°ì„  ì „ëµ + ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸)
  function loadList() {
    // 1í˜ì´ì§€ì¼ ë•Œë§Œ ë¡œë”© ë¬¸êµ¬ í‘œì‹œ (ìºì‹œê°€ ìˆìœ¼ë©´ ì´ì¡°ì°¨ë„ ì•ˆ ë³´ì¼ ë§Œí¼ ë¹ ë¦„)
    if(currentPage === 1) $('#listBody').html('<tr><td colspan="4">ë¡œë”© ì¤‘...</td></tr>');

    // [CASE A] ê´€ë¦¬ì ëª¨ë“œ: ë°ì´í„° ì •í™•ì„±ì´ ìƒëª…ì´ë¯€ë¡œ í•­ìƒ ì„œë²„(API)ì™€ í†µì‹ 
    if (currentAdminKey) {
      callApi("getList", { page: currentPage, adminKey: currentAdminKey }, renderList);
      return;
    }

    // [CASE B] ì¼ë°˜ ë°©ë¬¸ì ëª¨ë“œ: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ + JSON íŒŒì¼ í™œìš©

    // 1ë‹¨ê³„: ë¸Œë¼ìš°ì € ì €ì¥ì†Œ(LocalStorage) í™•ì¸ - (ì†ë„ 0.01ì´ˆ)
    var savedJson = localStorage.getItem("BOARD_CACHE");
    if (savedJson && currentPage === 1) {
      try {
        var parsedData = JSON.parse(savedJson);
        if (parsedData && parsedData.length > 0) {
          cachedData = parsedData; // ë©”ëª¨ë¦¬ì— ì˜¬ë¦¼
          console.log("âš¡ [Fast Load] ìºì‹œëœ ë°ì´í„°ë¡œ ì¦‰ì‹œ í™”ë©´ í‘œì‹œ");
          renderWithData(cachedData); // ê¸°ë‹¤ë¦¼ ì—†ì´ ë°”ë¡œ ê·¸ë¦¬ê¸°
        }
      } catch(e) {
        console.error("ìºì‹œ íŒŒì‹± ì˜¤ë¥˜(ë¬´ì‹œí•¨)", e);
      }
    }

    // 2ë‹¨ê³„: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  JSON íŒŒì¼ ìš”ì²­ - (ì†ë„ 0.5ì´ˆ)
    var jsonUrl = "https://drive.google.com/uc?export=download&id=" + JSON_FILE_ID;
    
    fetch(jsonUrl)
      .then(res => res.json())
      .then(data => {
        console.log("ğŸ”„ [Sync] ì„œë²„ ìµœì‹  ë°ì´í„° ë„ì°©");
        
        // ë°ì´í„° êµì²´
        cachedData = data.items; 

        // ë‹¤ìŒ ë°©ë¬¸ì„ ìœ„í•´ ë¸Œë¼ìš°ì € ì €ì¥ì†Œ ë®ì–´ì“°ê¸° (ìë™ ì‚­ì œ/ê°±ì‹  íš¨ê³¼)
        try { localStorage.setItem("BOARD_CACHE", JSON.stringify(cachedData)); } catch(e) {}

        // í™”ë©´ ê°±ì‹  (ìƒˆ ê¸€ì´ ìˆì—ˆë‹¤ë©´ ì´ë•Œ ë°”ë€œ)
        renderWithData(cachedData);
      })
      .catch(err => {
        console.error("JSON ë¡œë“œ ì‹¤íŒ¨", err);
        // ìºì‹œë„ ì—†ê³  íŒŒì¼ ë¡œë“œë„ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ë¹„ìƒìš© API í˜¸ì¶œ
        if (!cachedData || cachedData.length === 0) {
            callApi("getList", { page: currentPage, adminKey: "" }, renderList);
        }
      });
  }

  // [ë³´ì¡°] ë°ì´í„°ë¥¼ ë°›ì•„ í™”ë©´ì„ ê·¸ë¦¬ëŠ” ë‚´ë¶€ í•¨ìˆ˜
  function renderWithData(dataList) {
      var itemsPerPage = 15;
      var start = (currentPage - 1) * itemsPerPage;
      var end = start + itemsPerPage;
      
      renderList({
        isAdmin: false,
        items: dataList.slice(start, end),
        hasMore: dataList.length > end,
        success: true
      });
  }

  // [ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜] - ê¸°ì¡´ê³¼ ë™ì¼í•˜ì§€ë§Œ ì•ˆì „ì¥ì¹˜ ê°•í™”
  function renderList(response) {
    if (response.success === false) { showModal("ì„œë²„ ì˜¤ë¥˜: " + (response.msg || "ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."), 'alert'); return; }
    if (!response.items) { response.items = []; }

    isAdminMode = response.isAdmin || (currentAdminKey !== "");
    if (currentPage === 1) $('#listBody').empty();
    $('.col-chk').show(); 
    
    if(isAdminMode) {
      $('#writeBtn').show(); $('#adminToggleBtn').text('ğŸ”“ ë¡œê·¸ì•„ì›ƒ').attr('onclick', 'doLogout()'); $('#checkAll').show();
    } else {
      $('#writeBtn').hide(); $('#adminToggleBtn').text('ğŸ”’ ê´€ë¦¬ì').attr('onclick', 'openLoginModal()'); $('#checkAll').hide();
    }
    $('#bulkActionArea').hide();

    if (response.items.length === 0 && currentPage === 1) {
      $('#listBody').html('<tr><td colspan="4">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
      $('#moreBtn').hide(); return;
    }

    response.items.forEach(function(item) {
      var noDisplay = item.status === "ê²Œì‹œ" ? item.displayNo : "<span class='badge-wait'>[ëŒ€ê¸°]</span>";
      var titlePrefix = item.status !== "ê²Œì‹œ" ? "<span style='color:#ccc'>(ë¹„ê³µê°œ) </span>" : "";
      var chkHtml = isAdminMode ? `<input type="checkbox" class="list-chk" value="${item.rowNumber}" onclick="toggleBulkBtn()">` : "";
      var html = `<tr><td class="col-chk">${chkHtml}</td><td class="col-no">${noDisplay}</td><td class="col-title" onclick="openDetail(${item.rowNumber})"><span class="title-text">${titlePrefix}${item.title}</span></td><td class="col-date">${item.date}</td></tr>`;
      $('#listBody').append(html);
    });
    
    if (response.hasMore) { $('#moreBtn').show(); currentPage++; } else { $('#moreBtn').hide(); }
  }

  // [ìƒì„¸ë³´ê¸° í•¨ìˆ˜] - ìºì‹œëœ ë°ì´í„° í™œìš©í•˜ì—¬ ì¦‰ì‹œ ì˜¤í”ˆ (0ì´ˆ ë¡œë”©)
  function openDetail(rowNumber) {
    $('#vBody').html('ë¡œë”© ì¤‘...'); $('#vMedia').empty(); $('#vFiles').empty(); $('#vAdminArea').hide();
    $('#viewModal').css('display', 'flex');
    currentDetail.row = rowNumber;

    // ê´€ë¦¬ì: ìˆ˜ì •/ì‚­ì œë¥¼ ìœ„í•´ í•­ìƒ ìµœì‹  ìƒíƒœ í™•ì¸ (ì„œë²„ í˜¸ì¶œ)
    if (isAdminMode || currentAdminKey) {
       callApi("getPostDetail", { rowNumber: rowNumber }, function(data){ renderDetail(data, rowNumber); });
       return;
    }

    // ì¼ë°˜ ë°©ë¬¸ì: ì´ë¯¸ ë°›ì•„ë‘” cachedDataì—ì„œ ì°¾ìŒ (ì„œë²„ í˜¸ì¶œ X)
    var foundItem = cachedData.find(function(item) { return item.rowNumber === rowNumber; });

    if (foundItem) {
      // ì°¾ì•˜ìœ¼ë©´ ì¦‰ì‹œ ë Œë”ë§
      renderDetail(foundItem, rowNumber);
    } else {
      // (í˜¹ì‹œ ëª» ì°¾ì•˜ìœ¼ë©´) ë¹„ìƒìš© ì„œë²„ í˜¸ì¶œ
      callApi("getPostDetail", { rowNumber: rowNumber }, function(data){ renderDetail(data, rowNumber); });
    }
  }

  // [ìƒì„¸ ë‚´ìš© ê·¸ë¦¬ê¸°] - ë³¸ë¬¸, íŒŒì¼ë§í¬, ìœ íŠœë¸Œ ì²˜ë¦¬
  function renderDetail(data, rowNumber) {
    $('#vTitle').text(data.title); 
    $('#vBody').html(data.content); // HTML ë³¸ë¬¸ ë Œë”ë§
    
    currentDetail.fileLinks = data.fileLinks; 
    currentDetail.folderId = data.folderId; 
    currentDetail.status = data.status;

    // ê´€ë¦¬ì ë²„íŠ¼ í‘œì‹œ
    if(isAdminMode) {
      var buttons = `<button class="btn-custom btn-admin" onclick="openEditMode()">ìˆ˜ì •</button> `;
      if (data.status === "ê²Œì‹œ") buttons += `<button class="btn-custom btn-admin" onclick="changeStatus(${rowNumber}, 'ëŒ€ê¸°')">ëŒ€ê¸°ì „í™˜</button> `;
      else buttons += `<button class="btn-custom btn-success" onclick="changeStatus(${rowNumber}, 'ê²Œì‹œ')">ê²Œì‹œì „í™˜</button> `;
      buttons += `<button class="btn-custom btn-danger" onclick="deletePost(${rowNumber})">ì‚­ì œ</button>`;
      $('#vAdminArea').html(buttons).show();
    }

    // ì²¨ë¶€íŒŒì¼ ë° ìœ íŠœë¸Œ ë§í¬ ì²˜ë¦¬
    if (data.fileLinks && data.fileLinks.trim() !== "") {
      var lines = data.fileLinks.split('\n');
      lines.forEach(function(line, idx) {
        if(!line.trim()) return;
        var parts = line.split('|');
        var name = parts[0] || "íŒŒì¼"; var url = parts[1] || line; var fileId = parts[2] || "";
        var uniqueId = "file_" + idx;

        if (url.includes("youtube.com") || url.includes("youtu.be")) {
          var videoId = getYoutubeId(url);
          if (videoId) $('#vMedia').append(`<div class="video-container"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe></div>`);
        } else {
          var icon = "ğŸ“„";
          if (/\.(jpg|png|gif)$/i.test(name)) icon = "ğŸ“·";
          if (/\.pdf$/i.test(name)) icon = "ğŸ“•";
          if (/\.(xls|xlsx)$/i.test(name)) icon = "ğŸ“Š";
          var downloadUrl = "https://drive.google.com/uc?export=download&id=" + fileId;
          // íŒŒì¼ì€ í´ë¦­ ì‹œ ì•„ì½”ë””ì–¸ ì—´ë¦¼
          var html = `<div class="file-accordion-btn" onclick="$('#${uniqueId}').slideToggle()"><span class="file-icon">${icon}</span> ${name}</div><div id="${uniqueId}" class="file-actions-panel"><a href="https://drive.google.com/file/d/${fileId}/view" target="_blank" class="action-btn btn-view">ìƒˆ ì°½ì—ì„œ ë³´ê¸°</a><a href="${downloadUrl}" target="_blank" class="action-btn btn-down">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</a></div>`;
          $('#vFiles').append(html);
        }
      });
    }
  }

  // [ìœ íŠœë¸Œ ID ì¶”ì¶œ]
  function getYoutubeId(url) {
    var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    var match = url.match(regExp); return (match && match[2].length == 11) ? match[2] : null;
  }

  // [ê¸€ì“°ê¸° ëª¨ë‹¬ ì—´ê¸°]
  function openWriteModal() { $('#wHeader').text('ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±'); $('#wRowNumber').val(''); $('#wExistingFolderId').val(''); $('#existingFiles').empty(); $('#wTitle').val(''); $('#summernote').summernote('code', ''); $('#fileList').html('<div style="margin-bottom:5px;"><input type="file" name="wFiles"></div>'); $('#wIsSaved').val('false'); $('#btnCancel').text('ì·¨ì†Œ'); $('#writeModal').css('display', 'flex'); }
  
  // [ìˆ˜ì • ëª¨ë“œ ì§„ì…]
  function openEditMode() {
    closeModalDirect('viewModal');
    $('#wHeader').text('ê³µì§€ì‚¬í•­ ìˆ˜ì •');
    $('#wRowNumber').val(currentDetail.row);
    $('#wExistingFolderId').val(currentDetail.folderId);
    $('#wTitle').val($('#vTitle').text());
    $('#summernote').summernote('code', $('#vBody').html()); // ë³¸ë¬¸ ë‚´ìš© ì—ë””í„°ì— ì‚½ì…
    $('#existingFiles').empty();
    // ê¸°ì¡´ íŒŒì¼ ëª©ë¡ ë¡œë“œ
    if(currentDetail.fileLinks) {
       var lines = currentDetail.fileLinks.split('\n');
       lines.forEach(function(line) {
         if(!line.trim()) return;
         var parts = line.split('|');
         var name = parts[0];
         var html = `<div class="edit-file-item" data-link="${line}"><span>ğŸ“„ ${name}</span><button type="button" class="btn-file-del" onclick="$(this).parent().remove()">ì‚­ì œ</button></div>`;
         $('#existingFiles').append(html);
       });
    }
    $('#fileList').html('<div style="margin-bottom:5px;"><input type="file" name="wFiles"></div>');
    $('#wIsSaved').val('false'); $('#btnCancel').text('ì·¨ì†Œ');
    $('#writeModal').css('display', 'flex');
  }

  // [ì‘ì„± ì·¨ì†Œ í•¸ë“¤ëŸ¬]
  function handleWriteClose() { var isSaved = $('#wIsSaved').val() === 'true'; if (isSaved) { $('#writeModal').hide(); currentPage = 1; loadList(); } else { showModal("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br>ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', function() { $('#writeModal').hide(); }); } }
  
  // [ê²Œì‹œê¸€ ì €ì¥ (API í˜¸ì¶œ)] - ì €ì¥ í›„ì—ëŠ” ìë™ìœ¼ë¡œ JSONì´ ê°±ì‹ ë¨(ë°±ì—”ë“œ ë¡œì§)
  function submitPost(status) {
    var title = $('#wTitle').val(); var content = $('#summernote').summernote('code');
    if (!title) return showModal("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.", 'alert');
    showLoading("ì €ì¥ ì¤‘...");
    var keptLinks = [];
    $('.edit-file-item').each(function() { keptLinks.push($(this).attr('data-link')); });
    var fileInputs = document.getElementsByName('wFiles'); var promises = [];
    Array.from(fileInputs).forEach(function(input) { if (input.files.length > 0) { var file = input.files[0]; var p = new Promise(function(resolve) { var reader = new FileReader(); reader.onload = function(e) { resolve({ name: file.name, mimeType: file.type, data: e.target.result.split(',')[1] }); }; reader.readAsDataURL(file); }); promises.push(p); } });
    
    Promise.all(promises).then(function(files) { 
      var payload = { data: { password: currentAdminKey, title: title, content: content, status: status, files: files, rowNumber: $('#wRowNumber').val(), existingFolderId: $('#wExistingFolderId').val(), existingLinks: keptLinks.join('\n') } }; 
      callApi("savePost", payload, function(res) {
        hideLoading();
        if (res.success) { 
          if (status === 'ê²Œì‹œ') { $('#writeModal').hide(); showModal("ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.", 'alert', function() { currentPage=1; loadList(); }); } 
          else { $('#wIsSaved').val('true'); $('#btnCancel').text('ë‹«ê¸°'); showModal("ì„ì‹œì €ì¥ ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì°½ì„ ë‹«ìœ¼ë©´ ëª©ë¡ì´ ê°±ì‹ ë©ë‹ˆë‹¤.", 'alert', function(){ currentPage=1; loadList(); }); } 
        } else { showModal("ì˜¤ë¥˜: " + res.msg, 'alert'); } 
      });
    });
  }

  // [ì²´í¬ë°•ìŠ¤ ë° ì¼ê´„ ì²˜ë¦¬ ë¡œì§]
  function toggleAllChecks() { var checked = $('#checkAll').prop('checked'); $('.list-chk').prop('checked', checked); toggleBulkBtn(); }
  function toggleBulkBtn() { var count = $('.list-chk:checked').length; if(count > 0) $('#bulkActionArea').css('display', 'flex'); else $('#bulkActionArea').hide(); }
  function doBulk(action) { var checked = $('.list-chk:checked'); if(checked.length === 0) return; var rows = []; checked.each(function() { rows.push($(this).val()); }); var msg = (action === 'delete') ? "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ì„ íƒí•œ í•­ëª©ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"; showModal(msg, 'confirm', function() { showLoading("ì²˜ë¦¬ ì¤‘..."); callApi("processBulkAction", {actType: action, rows: rows, key: currentAdminKey}, function(res){ hideLoading(); if(res.success) { showModal("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.", 'alert', function() { currentPage=1; loadList(); $('#checkAll').prop('checked', false); }); } else showModal("ì˜¤ë¥˜: " + res.msg, 'alert'); }); }); }

  // [ì‚­ì œ ë° ìƒíƒœë³€ê²½]
  function deletePost(row) { showModal("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', function() { showLoading("ì‚­ì œ ì¤‘..."); callApi("deletePost", {row: row, folderId: currentDetail.folderId, key: currentAdminKey}, function(res){ hideLoading(); if(res.success){ showModal("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", 'alert', function(){ closeModalDirect('viewModal'); currentPage=1; loadList(); }); } }); }); }
  function changeStatus(row, status) { callApi("updateStatus", {row: row, status: status}, function() { showModal("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", 'alert', function(){ closeModalDirect('viewModal'); currentPage=1; loadList(); }); }); }

  // [ë¡œê·¸ì¸ ë° UI ìœ í‹¸]
  function openLoginModal() { $('#adminPwInput').val(''); $('#loginModal').css('display', 'flex'); setTimeout(function(){$('#adminPwInput').focus();},100); }
  function doLogin() { var pw=$('#adminPwInput').val(); if(!pw)return; currentAdminKey=pw; currentPage=1; loadList(); closeModalDirect('loginModal'); }
  function doLogout() { showModal("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",'confirm',function(){currentAdminKey=""; isAdminMode=false; currentPage=1; loadList();}); }
  function addFileInput() { $('#fileList').append('<div style="margin-top:5px; display:flex;"><input type="file" name="wFiles"> <button onclick="$(this).parent().remove()" style="border:none; bg:none; color:red; margin-left:5px;">x</button></div>'); }
  
  // [ëª¨ë‹¬ ë‹«ê¸° ë° ë¡œë”©ë°”]
  function closeModal(e, id, allowBgClick) { if (allowBgClick && e.target.id === id) document.getElementById(id).style.display = 'none'; }
  function closeModalDirect(id) { document.getElementById(id).style.display = 'none'; }
  function showLoading(msg) { $('#loadingMsg').html(msg); $('#loadingOverlay').css('display', 'flex'); }
  function hideLoading() { $('#loadingOverlay').hide(); }
  
  // [ì‹œìŠ¤í…œ ëª¨ë‹¬]
  var sysCallback = null;
  function showModal(msg, type, callback) {
    $('#sysMsg').html(msg); $('#sysBtnArea').empty(); sysCallback = callback;
    if (type === 'confirm') {
      $('#sysTitle').text('í™•ì¸');
      $('#sysBtnArea').append('<button class="btn-custom btn-admin" onclick="closeSystemModal()">ì·¨ì†Œ</button>');
      $('#sysBtnArea').append('<button class="btn-custom btn-write" style="display:inline-block;" onclick="confirmSystemModal()">í™•ì¸</button>');
    } else {
      $('#sysTitle').text('ì•Œë¦¼');
      $('#sysBtnArea').append('<button class="btn-custom btn-admin" onclick="confirmSystemModal()">í™•ì¸</button>');
    }
    $('#systemModal').css('display', 'flex');
  }
  function closeSystemModal() { $('#systemModal').hide(); }
  function confirmSystemModal() { $('#systemModal').hide(); if (sysCallback) sysCallback(); }
</script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-ko-KR.min.js"></script>
</body>
</html>
